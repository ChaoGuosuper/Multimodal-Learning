# éš§é“ç«ç¾å¤šæ¨¡æ€é¢„æµ‹æ¨¡åž‹

æœ¬é¡¹ç›®å®žçŽ°äº†ä¸€ä¸ªåŸºäºŽæ·±åº¦å­¦ä¹ çš„éš§é“ç«ç¾å¤šæ¨¡æ€é¢„æµ‹ç³»ç»Ÿï¼Œèƒ½å¤Ÿç»“åˆç«ç„°å›¾åƒå’Œæ¸©åº¦ä¼ æ„Ÿå™¨æ•°æ®æ¥é¢„æµ‹çƒ­é‡Šæ”¾çŽ‡ï¼ˆHRRï¼‰ã€‚è¯¥ç³»ç»Ÿå…·æœ‰åŠ¨æ€æƒé‡è°ƒæ•´ã€è·¨æ¨¡æ€æ˜ å°„å’Œä¼ æ„Ÿå™¨å¼‚å¸¸æ£€æµ‹ç­‰å…ˆè¿›åŠŸèƒ½ã€‚


## âœ¨ ä¸»è¦ç‰¹æ€§

### ðŸ”¥ å¤šæ¨¡æ€èžåˆ
- **å›¾åƒæ¨¡æ€**ï¼šåŸºäºŽVGGæž¶æž„çš„ç«ç„°å›¾åƒç‰¹å¾æå–
- **ä¼ æ„Ÿå™¨æ¨¡æ€**ï¼šæ¸©åº¦ä¸Šå‡æ•°æ®çš„æ·±åº¦å¤„ç†
- **åŠ¨æ€æƒé‡è°ƒæ•´**ï¼šæ ¹æ®ä¼ æ„Ÿå™¨å¯é æ€§è‡ªåŠ¨è°ƒæ•´æ¨¡æ€æƒé‡

### ðŸ§  æ™ºèƒ½ç‰¹æ€§
- **è·¨æ¨¡æ€æ˜ å°„**ï¼šå­¦ä¹ ç«ç„°é¢ç§¯ä¸Žæ¸©åº¦çš„æ˜ å°„å…³ç³»
- **å¼‚å¸¸æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹ä¼ æ„Ÿå™¨æ•…éšœå’Œå¼‚å¸¸æ•°æ®
- **ç¼ºå¤±æ•°æ®å¤„ç†**ï¼šå½“ä¼ æ„Ÿå™¨å¤±æ•ˆæ—¶ï¼Œä»…ä½¿ç”¨å›¾åƒæ•°æ®è¿›è¡Œé¢„æµ‹

### ðŸ“Š æ¨¡åž‹æž¶æž„
- **FlameAreaExtractor**ï¼šæå–ç«ç„°é¢ç§¯ç‰¹å¾
- **AreaToTempRegressor**ï¼šå­¦ä¹ é¢ç§¯-æ¸©åº¦æ˜ å°„å…³ç³»
- **WeightGenerator**ï¼šåŠ¨æ€ç”Ÿæˆæ¨¡æ€å¯é æ€§æƒé‡
- **MultiModalModel**ï¼šä¸»é¢„æµ‹æ¨¡åž‹

## ðŸš€ å¿«é€Ÿå¼€å§‹

### çŽ¯å¢ƒè¦æ±‚

```bash
Python >= 3.8
PyTorch >= 1.9.0
PyTorch Lightning >= 1.5.0
torchvision >= 0.10.0
numpy >= 1.21.0
pandas >= 1.3.0
matplotlib >= 3.4.0
seaborn >= 0.11.0
scikit-learn >= 1.0.0
```

### å®‰è£…ä¾èµ–

```bash
pip install torch torchvision pytorch-lightning
pip install numpy pandas matplotlib seaborn scikit-learn
```

### æ•°æ®å‡†å¤‡

1. åˆ›å»ºæ•°æ®ç›®å½•ç»“æž„ï¼š
```
data_multi/
â”œâ”€â”€ Fire.pkl          # åŒ…å«æ—¶é—´ã€æ¸©åº¦ä¸Šå‡ã€HRRç­‰æ•°æ®
â””â”€â”€ Fire/             # ç«ç„°å›¾åƒæ–‡ä»¶å¤¹
    â”œâ”€â”€ 1.jpg
    â”œâ”€â”€ 2.jpg
    â””â”€â”€ ...
```

2. æ•°æ®æ ¼å¼è¦æ±‚ï¼š
   - `Fire.pkl`ï¼šåŒ…å«åˆ— `['Time', 'Tem_rise', 'HRR']`
   - å›¾åƒæ–‡ä»¶ï¼šä»¥æ—¶é—´æˆ³å‘½åçš„JPGæ ¼å¼ç«ç„°å›¾åƒ

### è®­ç»ƒæ¨¡åž‹

```bash
python multiinput_regression-DSV1.py
```

è®­ç»ƒè¿‡ç¨‹å°†è‡ªåŠ¨ï¼š
- åŠ è½½å’Œé¢„å¤„ç†æ•°æ®
- è®­ç»ƒå¤šæ¨¡æ€æ¨¡åž‹
- ä¿å­˜æœ€ä½³æ¨¡åž‹æ£€æŸ¥ç‚¹
- ç”Ÿæˆè®­ç»ƒæ—¥å¿—å’Œå¯è§†åŒ–ç»“æžœ

### æ¨¡åž‹æµ‹è¯•

```bash
python multiinput_test_onescenario-DSV1.py
```

## ðŸ“ é¡¹ç›®ç»“æž„

```
â”œâ”€â”€ multiinput_regression.py      # ä¸»è®­ç»ƒè„šæœ¬
â”œâ”€â”€ multiinput_test_onescenario.py # æ¨¡åž‹æµ‹è¯•è„šæœ¬
â”œâ”€â”€ data_multi/                        # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ Fire.pkl                      # è¡¨æ ¼æ•°æ®
â”‚   â””â”€â”€ Fire/                         # å›¾åƒæ•°æ®
â”œâ”€â”€ Fire/                             # è®­ç»ƒæ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ dynamic_multimodal_Fire/      # TensorBoardæ—¥å¿—
â””â”€â”€ README.md                         # é¡¹ç›®æ–‡æ¡£
```

## ðŸ—ï¸ æ¨¡åž‹æž¶æž„è¯¦è§£

### 1. å›¾åƒç‰¹å¾æå–
```python
# VGGé£Žæ ¼çš„å·ç§¯å—
conv_blocks = nn.Sequential(
    vgg_block(3, 64),      # è¾“å…¥RGBå›¾åƒ
    vgg_block(64, 128),    # ç‰¹å¾æå–
    vgg_block(128, 256),   # æ·±å±‚ç‰¹å¾
    vgg_block(256, 512),   # é«˜çº§ç‰¹å¾
    vgg_block(512, 512),   # æœ€ç»ˆç‰¹å¾
    nn.AdaptiveAvgPool2d((7, 7))
)
```

### 2. è·¨æ¨¡æ€æ˜ å°„
```python
# ç«ç„°é¢ç§¯æå–å™¨
area_extractor = FlameAreaExtractor()
# é¢ç§¯-æ¸©åº¦å›žå½’å™¨
temp_regressor = AreaToTempRegressor()
```

### 3. åŠ¨æ€æƒé‡ç”Ÿæˆ
```python
# æƒé‡ç”Ÿæˆå™¨
weight_generator = WeightGenerator(
    img_feat_dim=256,
    tab_feat_dim=64,
    window_size=10
)
```

## ðŸ“ˆ è®­ç»ƒé…ç½®

### è¶…å‚æ•°è®¾ç½®
- **å­¦ä¹ çŽ‡**ï¼š1e-4
- **æ‰¹æ¬¡å¤§å°**ï¼š32
- **æœ€å¤§è®­ç»ƒè½®æ•°**ï¼š300
- **æ—©åœè€å¿ƒ**ï¼š20è½®
- **æ¢¯åº¦è£å‰ª**ï¼š0.5
- **æ¢¯åº¦ç´¯ç§¯**ï¼š4ä¸ªæ‰¹æ¬¡

### æŸå¤±å‡½æ•°
```python
total_loss = main_loss + 0.3 * temp_loss + 0.1 * weight_penalty
```
- **ä¸»æŸå¤±**ï¼šHRRé¢„æµ‹çš„L1æŸå¤±
- **æ¸©åº¦æŸå¤±**ï¼šè·¨æ¨¡æ€æ˜ å°„çš„MSEæŸå¤±
- **æƒé‡æ­£åˆ™åŒ–**ï¼šé˜²æ­¢æ¨¡æ€æƒé‡è¿‡äºŽæžç«¯

### å­¦ä¹ çŽ‡è°ƒåº¦
ä½¿ç”¨`ReduceLROnPlateau`è°ƒåº¦å™¨ï¼š
- ç›‘æŽ§éªŒè¯æŸå¤±
- è€å¿ƒå€¼ï¼š10è½®
- è¡°å‡å› å­ï¼š0.5

## ðŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. å¼‚å¸¸æ£€æµ‹æœºåˆ¶
```python
def detect_abnormality(self, tabular_data, window_size=5, zero_threshold=1e-6):
    # 1. çªå‘å¼‚å¸¸å€¼æ£€æµ‹
    abnorm_mask = torch.abs(tabular_data) > 500.0
    
    # 2. æŒç»­é›¶å€¼æ£€æµ‹ï¼ˆä¼ æ„Ÿå™¨å¤±æ•ˆï¼‰
    if len(tabular_data) >= window_size:
        zero_windows = torch.stack([
            (torch.abs(tabular_data[i:i + window_size]) < zero_threshold)
            for i in range(len(tabular_data) - window_size + 1)
        ])
        full_zero_mask = torch.all(zero_windows, dim=1)
        # ... æ‰©å±•ä¸ºé€ç‚¹æ ‡è®°
```

### 2. åŠ¨æ€æƒé‡è°ƒæ•´
```python
# å½“æ£€æµ‹åˆ°ä¼ æ„Ÿå™¨å¼‚å¸¸æ—¶
if abnorm_flags.any():
    weights = torch.stack([
        weights[:, 0] + 0.4,  # æé«˜å›¾åƒæƒé‡
        weights[:, 1] * 0.1   # é™ä½Žæ¸©åº¦æƒé‡
    ], dim=1)
    weights = F.softmax(weights, dim=1)
```

### 3. ç¼ºå¤±æ•°æ®å¤„ç†
```python
def handle_missing_temp(self, img):
    # ä»…ä½¿ç”¨å›¾åƒç‰¹å¾è¿›è¡Œé¢„æµ‹
    img_feat = self.image_fc(self.conv_blocks(img))
    temp_pred = self.last_temp_pred  # ä½¿ç”¨ç¼“å­˜çš„æ¸©åº¦é¢„æµ‹
    tab_feat = self.tabular_fc(temp_pred)
    
    # è°ƒæ•´æƒé‡åå‘å›¾åƒæ¨¡æ€
    weights = torch.tensor([[0.9, 0.1]], device=self.device)
    # ... åŠ æƒèžåˆ
```

## ðŸ“Š è¯„ä¼°æŒ‡æ ‡

æ¨¡åž‹è®­ç»ƒå®ŒæˆåŽä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹è¯„ä¼°æŒ‡æ ‡ï¼š

- **MAE**ï¼šå¹³å‡ç»å¯¹è¯¯å·®
- **RMSE**ï¼šå‡æ–¹æ ¹è¯¯å·®
- **RÂ² Score**ï¼šå†³å®šç³»æ•°
- **åŠ¨æ€æƒé‡åˆ†å¸ƒ**ï¼šå„æ¨¡æ€çš„æƒé‡å˜åŒ–è¶‹åŠ¿

## ðŸ“ˆ å¯è§†åŒ–ç»“æžœ

è®­ç»ƒå’Œæµ‹è¯•è¿‡ç¨‹ä¼šç”Ÿæˆä»¥ä¸‹å¯è§†åŒ–å›¾è¡¨ï¼š

1. **çœŸå®žå€¼ vs é¢„æµ‹å€¼æ•£ç‚¹å›¾**ï¼šæ˜¾ç¤ºé¢„æµ‹ç²¾åº¦
2. **æ—¶é—´åºåˆ—å¯¹æ¯”**ï¼šå±•ç¤ºé¢„æµ‹è¶‹åŠ¿
3. **åŠ¨æ€æƒé‡è°ƒæ•´**ï¼šæ˜¾ç¤ºæ¨¡æ€æƒé‡å˜åŒ–
4. **æ¸©åº¦é¢„æµ‹å¯¹æ¯”**ï¼šè·¨æ¨¡æ€æ˜ å°„æ•ˆæžœ

## ðŸ› ï¸ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹æ¨¡åž‹å‚æ•°
```python
model = MultiModalModel(
    lr=1e-4,           # å­¦ä¹ çŽ‡
    batch_size=32      # æ‰¹æ¬¡å¤§å°
)
```

### è°ƒæ•´è®­ç»ƒå‚æ•°
```python
trainer = pl.Trainer(
    max_epochs=300,           # æœ€å¤§è®­ç»ƒè½®æ•°
    gradient_clip_val=0.5,    # æ¢¯åº¦è£å‰ª
    accumulate_grad_batches=4 # æ¢¯åº¦ç´¯ç§¯
)
```

### è‡ªå®šä¹‰æ•°æ®è·¯å¾„
```python
data_path = "./your_data_path/"
```

## ðŸ” æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **CUDAå†…å­˜ä¸è¶³**
   - å‡å°æ‰¹æ¬¡å¤§å°
   - ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯
   - å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒ

2. **æ•°æ®åŠ è½½é”™è¯¯**
   - æ£€æŸ¥æ•°æ®è·¯å¾„æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤å›¾åƒæ–‡ä»¶æ ¼å¼ä¸ºJPG
   - éªŒè¯pklæ–‡ä»¶åŒ…å«å¿…è¦åˆ—

3. **æ¨¡åž‹æ”¶æ•›ç¼“æ…¢**
   - è°ƒæ•´å­¦ä¹ çŽ‡
   - å¢žåŠ è®­ç»ƒè½®æ•°
   - æ£€æŸ¥æ•°æ®è´¨é‡

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®é¢„å¤„ç†**
   - ä½¿ç”¨å¤šè¿›ç¨‹æ•°æ®åŠ è½½
   - é¢„è®¡ç®—å›¾åƒç‰¹å¾
   - æ•°æ®ç¼“å­˜æœºåˆ¶

2. **æ¨¡åž‹ä¼˜åŒ–**
   - ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
   - æ¨¡åž‹é‡åŒ–
   - çŸ¥è¯†è’¸é¦

## ðŸ“š å‚è€ƒæ–‡çŒ®

1. VGGç½‘ç»œæž¶æž„
2. å¤šæ¨¡æ€å­¦ä¹ ç†è®º
3. åŠ¨æ€æƒé‡è°ƒæ•´æ–¹æ³•
4. ä¼ æ„Ÿå™¨å¼‚å¸¸æ£€æµ‹æŠ€æœ¯

## ðŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿Žæäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›é¡¹ç›®ï¼š

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æŽ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»ºPull Request

## ðŸ“ž è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- å‘é€é‚®ä»¶è‡³ chaoguo@shnu.edu.cn
